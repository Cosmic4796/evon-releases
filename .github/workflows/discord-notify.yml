name: Discord Update Notification

on:
  push:
    paths:
      - 'update-manifest.json'
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          VERSION=$(jq -r '.version' update-manifest.json)
          RELEASE_DATE=$(jq -r '.releaseDate' update-manifest.json)
          IS_CRITICAL=$(jq -r '.isCritical' update-manifest.json)
          DOWNLOAD_URL=$(jq -r '.downloadUrl' update-manifest.json)

          # Build changelog with proper newlines
          CHANGELOG=$(jq -r '.changelog[] |
            (if .type == "security" then "ðŸ›¡ï¸"
             elif .type == "feature" then "âœ¨"
             elif .type == "fix" then "ðŸ›"
             elif .type == "improvement" then "âš¡"
             else "ðŸ“" end) + " **" + .type + ":** " + .text' update-manifest.json | tr '\n' '|' | sed 's/|/\\n/g')

          if [ "$IS_CRITICAL" = "true" ]; then
            COLOR=15158332
            TITLE="ðŸš¨ CRITICAL UPDATE: EVON Obfuscator v${VERSION}"
            CRITICAL_MSG="\\n> âš ï¸ **This is a critical security update!**\\n> Update now to keep your scripts protected!\\n"
          else
            COLOR=5814783
            TITLE="ðŸš€ EVON Obfuscator v${VERSION} Released!"
            CRITICAL_MSG=""
          fi

          cat > payload.json << EOF
          {
            "username": "EVON Updates",
            "avatar_url": "https://raw.githubusercontent.com/Cosmic4796/evon-releases/main/icon.png",
            "embeds": [
              {
                "title": "${TITLE}",
                "description": "${CRITICAL_MSG}**ðŸ“‹ What's New:**\\n\\n${CHANGELOG}",
                "color": ${COLOR},
                "thumbnail": {
                  "url": "https://raw.githubusercontent.com/Cosmic4796/evon-releases/main/icon.png"
                },
                "fields": [
                  {
                    "name": "ðŸ“¥ How to Update",
                    "value": "**Auto:** Open EVON â†’ Click 'Update Now'\\n**Manual:** [â¬‡ï¸ Download Installer](${DOWNLOAD_URL})",
                    "inline": false
                  },
                  {
                    "name": "ðŸ·ï¸ Version",
                    "value": "\`v${VERSION}\`",
                    "inline": true
                  },
                  {
                    "name": "ðŸ“… Released",
                    "value": "${RELEASE_DATE}",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "EVON Obfuscator â€¢ Automatic Updates Enabled",
                  "icon_url": "https://raw.githubusercontent.com/Cosmic4796/evon-releases/main/icon.png"
                }
              }
            ]
          }
          EOF

          curl -s -H "Content-Type: application/json" -d @payload.json $DISCORD_WEBHOOK
          echo "Notification sent!"
