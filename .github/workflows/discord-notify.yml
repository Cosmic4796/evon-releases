  name: Discord Update Notification

  on:
    push:
      paths:
        - 'update-manifest.json'
      branches:
        - main

  jobs:
    notify:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Read manifest and send Discord notification
          env:
            DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          run: |
            VERSION=$(jq -r '.version' update-manifest.json)
            RELEASE_DATE=$(jq -r '.releaseDate' update-manifest.json)
            IS_CRITICAL=$(jq -r '.isCritical' update-manifest.json)
            DOWNLOAD_URL=$(jq -r '.downloadUrl' update-manifest.json)

            CHANGELOG=""
            CHANGELOG_LENGTH=$(jq '.changelog | length' update-manifest.json)

            for i in $(seq 0 $(($CHANGELOG_LENGTH - 1))); do
              TYPE=$(jq -r ".changelog[$i].type" update-manifest.json)
              TEXT=$(jq -r ".changelog[$i].text" update-manifest.json)

              case $TYPE in
                "security") EMOJI="ðŸ›¡ï¸" ;;
                "feature") EMOJI="âœ¨" ;;
                "fix") EMOJI="ðŸ›" ;;
                "improvement") EMOJI="âš¡" ;;
                *) EMOJI="ðŸ“" ;;
              esac

              CHANGELOG="$CHANGELOG$EMOJI **[$TYPE]** $TEXT\\n"
            done

            if [ "$IS_CRITICAL" = "true" ]; then
              COLOR=15158332
              CRITICAL_BANNER="âš ï¸ **CRITICAL SECURITY UPDATE** âš ï¸\\n_You should really update to keep your scripts safe!_\\n\\n"
            else
              COLOR=5814783
              CRITICAL_BANNER=""
            fi

            cat > payload.json << 'EOF'
            {
              "username": "EVON Updates",
              "avatar_url": "https://raw.githubusercontent.com/Cosmic4796/evon-releases/main/icon.png",
              "embeds": [
                {
                  "title": "ðŸš€ EVON Obfuscator vVERSION_PLACEHOLDER Released!",
                  "description": "CRITICAL_PLACEHOLDERðŸ“‹ **Changelog:**\nCHANGELOG_PLACEHOLDER",
                  "color": COLOR_PLACEHOLDER,
                  "thumbnail": {
                    "url": "https://raw.githubusercontent.com/Cosmic4796/evon-releases/main/icon.png"
                  },
                  "fields": [
                    {
                      "name": "ðŸ“¥ How to Update",
                      "value": "â€¢ **Auto-Update:** Just open EVON and click 'Update Now'\nâ€¢ **Manual:** [Download Here](DOWNLOAD_PLACEHOLDER)",
                      "inline": false
                    },
                    {
                      "name": "ðŸ·ï¸ Version",
                      "value": "vVERSION_PLACEHOLDER",
                      "inline": true
                    },
                    {
                      "name": "ðŸ“… Release Date",
                      "value": "DATE_PLACEHOLDER",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "EVON Obfuscator â€¢ Automatic Update Available",
                    "icon_url": "https://raw.githubusercontent.com/Cosmic4796/evon-releases/main/icon.png"
                  }
                }
              ]
            }
            EOF

            sed -i "s|VERSION_PLACEHOLDER|$VERSION|g" payload.json
            sed -i "s|CRITICAL_PLACEHOLDER|$CRITICAL_BANNER|g" payload.json
            sed -i "s|CHANGELOG_PLACEHOLDER|$CHANGELOG|g" payload.json
            sed -i "s|COLOR_PLACEHOLDER|$COLOR|g" payload.json
            sed -i "s|DOWNLOAD_PLACEHOLDER|$DOWNLOAD_URL|g" payload.json
            sed -i "s|DATE_PLACEHOLDER|$RELEASE_DATE|g" payload.json

            curl -H "Content-Type: application/json" -d @payload.json $DISCORD_WEBHOOK
