name: Discord Update Notification

on:
  push:
    paths:
      - 'update-manifest.json'
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read manifest and send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # Read the manifest
          VERSION=$(jq -r '.version' update-manifest.json)
          RELEASE_DATE=$(jq -r '.releaseDate' update-manifest.json)
          IS_CRITICAL=$(jq -r '.isCritical' update-manifest.json)
          DOWNLOAD_URL=$(jq -r '.downloadUrl' update-manifest.json)

          # Build changelog text
          CHANGELOG=""
          CHANGELOG_LENGTH=$(jq '.changelog | length' update-manifest.json)

          for i in $(seq 0 $(($CHANGELOG_LENGTH - 1))); do
            TYPE=$(jq -r ".changelog[$i].type" update-manifest.json)
            TEXT=$(jq -r ".changelog[$i].text" update-manifest.json)

            # Add emoji based on type
            case $TYPE in
              "security") EMOJI="ðŸ›¡ï¸" ;;
              "feature") EMOJI="âœ¨" ;;
              "fix") EMOJI="ðŸ›" ;;
              "improvement") EMOJI="âš¡" ;;
              *) EMOJI="ðŸ“" ;;
            esac

            CHANGELOG="$CHANGELOG$EMOJI **[$TYPE]** $TEXT\\n"
          done

          # Set color based on critical status
          if [ "$IS_CRITICAL" = "true" ]; then
            COLOR=15158332
            CRITICAL_BANNER="\\nâš ï¸ **CRITICAL SECURITY UPDATE** âš ï¸\\n_You should really update to keep your scripts safe!_\\n"
          else
            COLOR=5814783
            CRITICAL_BANNER=""
          fi

          # Create Discord embed JSON
          cat > payload.json << EOF
          {
            "embeds": [
              {
                "title": "ðŸš€ EVON Obfuscator v${VERSION} Released!",
                "description": "${CRITICAL_BANNER}\\n**ðŸ“‹ Changelog:**\\n${CHANGELOG}",
                "color": ${COLOR},
                "fields": [
                  {
                    "name": "ðŸ“¥ How to Update",
                    "value": "â€¢ **Auto-Update:** Just open EVON and click 'Update Now'\\nâ€¢ **Manual:** [Download Here](${DOWNLOAD_URL})",
                    "inline": false
                  },
                  {
                    "name": "ðŸ“¦ Version",
                    "value": "v${VERSION}",
                    "inline": true
                  },
                  {
                    "name": "ðŸ“… Release Date",
                    "value": "${RELEASE_DATE}",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "EVON Obfuscator â€¢ Automatic Update Available"
                },
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
              }
            ]
          }
          EOF

          # Send to Discord
          curl -H "Content-Type: application/json" -d @payload.json $DISCORD_WEBHOOK

          echo "âœ… Discord notification sent!"
